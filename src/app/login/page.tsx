"use client";

import { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { Form, Input, Button, Card, message, Typography, Row, Col } from "antd";
import {
  UserOutlined,
  LockOutlined,
  ArrowRightOutlined,
} from "@ant-design/icons";
import Image from "next/image";
import { useRouter } from "next/navigation";

const { Title, Text } = Typography;
const PRIMARY_COLOR = "#1890ff";

interface LoginForm {
  username: string;
  password: string;
}

export default function LoginPage() {
  const [loading, setLoading] = useState(false);
  const router = useRouter();
  const { isAuthenticated, login } = useAuth();

  useEffect(() => {
    if (isAuthenticated) {
      router.replace("/timetable");
    }
  }, [isAuthenticated, router]);

  const onFinish = async (values: LoginForm) => {
    try {
      setLoading(true);
      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: values.username,
          password: values.password,
        }),
      });
      const data = await res.json();
      if (!res.ok) {
        message.error(data.message || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i");
        return;
      }
      // Use context login to update state and localStorage
      login(data.token, data.user);
      message.success("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!");
      // Redirect handled by useEffect above
    } catch (error) {
      console.error("Login error:", error);
      message.error("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i");
    } finally {
      setLoading(false);
    }
  };

  return (
    // N·ªÅn: TƒÉng c∆∞·ªùng ƒë·ªô ph·ªß s√≥ng
    <div className="w-screen h-screen flex items-center justify-center bg-gradient-to-r from-blue-50 to-indigo-100 p-0">
      <div className="w-full h-full bg-white shadow-none overflow-hidden flex transition duration-500">
        <Row gutter={[0, 0]} className="w-full h-full">
          {/* C·ªôt 1: H√¨nh ·∫£nh/Minh h·ªça (B√¢y gi·ªù chi·∫øm 50% m√†n h√¨nh) */}
          <Col xs={0} md={12} className="relative flex flex-col justify-center items-center text-white">
            {/* Background Image */}
            <div className="absolute inset-0 w-full h-full">
              <Image
                src="/images/background.jpg"
                alt="Background"
                fill
                className="object-cover"
                priority
              />
              {/* Overlay to make text more readable */}
              <div className="absolute inset-0 bg-black/30" />
            </div>
            
            {/* Content on top of background */}
            <div className="relative z-10 text-center p-10">
              <Title level={2} className="text-white !mt-0 !mb-2">
                Qu·∫£n L√Ω Thi·∫øt B·ªã
              </Title>
              <Text className="text-white/80 text-lg block">
                H·ªá th·ªëng qu·∫£n l√Ω v·∫≠t t∆∞ v√† thi·∫øt b·ªã ph√≤ng th√≠ nghi·ªám ƒëi·ªán t·ª≠ c·ªßa b·∫°n.
              </Text>
              <Text className="text-white/90 mt-4 block">
                TK: ndloi@hcmct.edu.vn
                <br />
                MK: 123456
              </Text>
            </div>
          </Col>

          {/* C·ªôt 2: Form ƒêƒÉng nh·∫≠p (B√¢y gi·ªù chi·∫øm 50% m√†n h√¨nh) */}
          <Col
            xs={24}
            md={12}
            className="p-8 sm:p-12 lg:p-16 flex flex-col justify-center items-center"
          >
            {/* üåü Th√™m m·ªôt div ƒë·ªÉ gi·ªõi h·∫°n form l·∫°i ·ªü trung t√¢m c·ªôt, tr√°nh b·ªã qu√° r·ªông */}
            <div className="w-full max-sm:-sm">
              <div className="flex flex-col items-center mb-10">
                <div className="relative w-35 h-16 mb-4">
                  <Image
                    src="/images/logo.png"
                    alt="Logo"
                    fill
                    className="object-contain"
                    priority
                  />
                </div>
                <Title level={3} className="text-center !mb-1 text-gray-800">
                  Ch√†o m·ª´ng tr·ªü l·∫°i!
                </Title>
                <Text type="secondary" className="text-center">
                  Vui l√≤ng nh·∫≠p th√¥ng tin ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c
                </Text>
              </div>

              {/* Form Ant Design */}
              <Form
                name="login"
                initialValues={{ remember: true }}
                onFinish={onFinish}
                layout="vertical"
                size="large"
              >
                <Form.Item
                  label="T√™n ƒëƒÉng nh·∫≠p"
                  name="username"
                  rules={[
                    { required: true, message: "Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p!" },
                  ]}
                >
                  <Input
                    prefix={<UserOutlined className="text-gray-400" />}
                    placeholder="T√™n ng∆∞·ªùi d√πng ho·∫∑c Email"
                  />
                </Form.Item>

                <Form.Item
                  label="M·∫≠t kh·∫©u"
                  name="password"
                  rules={[
                    { required: true, message: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!" },
                    { min: 6, message: "M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±" },
                  ]}
                >
                  <Input.Password
                    prefix={<LockOutlined className="text-gray-400" />}
                    placeholder="M·∫≠t kh·∫©u"
                  />
                </Form.Item>

                <Form.Item className="!mt-8">
                  <Button
                    type="primary"
                    htmlType="submit"
                    className="w-full h-12 flex items-center justify-center font-semibold text-lg"
                    loading={loading}
                    icon={<ArrowRightOutlined />}
                    style={{ backgroundColor: PRIMARY_COLOR }}
                  >
                    {loading ? "ƒêang ƒëƒÉng nh·∫≠p..." : "ƒêƒÉng Nh·∫≠p"}
                  </Button>
                </Form.Item>

                <div className="flex justify-between items-center mt-4">
                  <Typography.Link className="text-sm text-gray-600 hover:text-indigo-500 transition">
                    Qu√™n m·∫≠t kh·∫©u?
                  </Typography.Link>
                  <Text className="text-sm text-gray-500">
                    Ch∆∞a c√≥ t√†i kho·∫£n?{" "}
                    <Typography.Link
                      onClick={() => router.push("/register")}
                      className="font-medium text-indigo-500 hover:text-indigo-700 transition"
                    >
                      ƒêƒÉng k√Ω
                    </Typography.Link>
                  </Text>
                </div>
              </Form>
            </div>
          </Col>
        </Row>
      </div>
    </div>
  );
}
